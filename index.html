<html>
<head>
<title> XSS SCANNER v1.0 </title>
<meta charset="utf-8">

<link rel="stylesheet" type="text/css" href="mystyle.css">

<script type="text/javascript">

function verifyDOM(url){
  url = 'http://allow-any-origin.appspot.com/' + url;
  alert(url);
  xmlhttp=new XMLHttpRequest();
  xmlhttp.open("GET",url,false);
  xmlhttp.send();
  parser=new DOMParser();
  alert(xmlhttp.responseText);
}

function ValidURL(textval) {
  //For test into private net remove proxy
  urlControl = 'http://allow-any-origin.appspot.com/' + textval;
  xhr = new XMLHttpRequest();
  xhr.open("GET",urlControl,false);
  //xhr.responseType= "text";
  xhr.send();
  verifyURL = new DOMParser();
  var sito = xhr.responseText;
  UrlExist = xhr.status;
  if (UrlExist != 200)
  {
    return false;
  }
  //console.log("Ecco la pagina HTML del sito: " , urlControl);
  //console.log(sito);
  riga = sito.split('\n');
  var posizione, stringa, value_post, stringa_post, pos_temp,str_temp, UrlDaControllare;
  var linkOnPage=[];
  //Trovo i campi name per inject XSS
   for (var x=0; x<riga.length; x++){
          posizione=riga[x];
          //stringa = posizione.indexOf("<form ");
          stringa = posizione.indexOf('type="text"');

          if (stringa != -1){
     pos_temp = posizione.indexOf("name=");
      if (pos_temp != -1){
        pos_temp = posizione.substring(pos_temp+5);
        value_post = pos_temp.match(/"([^"]+)"/)[1];
        //Partendo dal numero di riga dove ho trovato il campo "type=text" faccio una ricerca inversa per trovare i campi del form
        for (var y=x; y>0;y--){
          pos_temp = riga[y];
          str_temp = pos_temp.lastIndexOf("<form");
          if (str_temp != -1 ){
          str_temp =  pos_temp.substring(str_temp+5);
          stringa_post = str_temp.match(/"([^"]+)"/)[1];
          //console.log(y,stringa_post,value_post);
          UrlDaControllare=urlControl+'/'+stringa_post;
          //console.log(UrlDaControllare, value_post);
             xssExist = TestXSS("GET", UrlDaControllare,value_post);

        }
      }
     }
   }

   }
}

function TestXSS(method,url,parameters){

  var responseStatus,length_file, allText;
  var params="payloads";
  var Param_reader = new FileReader();
  //Leggo il file di configurazione per caricare i payloads
  var rawFile = new XMLHttpRequest();
  rawFile.open("GET", params, false);
  rawFile.onreadystatechange = function ()
  {
      if(rawFile.readyState === 4)
      {
          if(rawFile.status === 200 || rawFile.status == 0)
          {
              allText = rawFile.responseText;
              allText = allText.split('\n');
              length_file = allText.length;
              //La variabile allText è un array che contiene tutti i payloads da testare per l'attacco
          }
      }
  }
  rawFile.send(null);
   var test_xss = new XMLHttpRequest();
   var stringaGet, ResponseSite, stringaConfronto;
   //testo tutti i parametri che ho nel file
   for (var z=0; z< (length_file - 1); z++){
     //console.log("Parametro da testare:", allText[z] );
     stringaGet= (url + "?" + parameters + "=" + allText[z]);
     //console.log(stringaGet);
     test_xss.open(method,stringaGet,false);
     test_xss.send();
     console.log("sito: " ,stringaGet);
     ResponseSite = test_xss.responseText;


    stringaConfronto = ResponseSite.indexOf(allText[z]);
  //Controllo la risposta del sito è se trovo la stessa stringa che ho iniettato significa che probabilmente ho un XSS
     if (stringaConfronto != -1){
       alert("Possibile XSS!!!!");
     }
   }
}


  /*xssTest = new XMLHttpRequest();
  xssTest.open(method,url,false);
  xssTest.send(params);
  var sito = xssTest.responseText;
  responseStatus = xssTest.status;
  console.log(responseStatus);
*/
</script>

</head>

 <body>
   <h1> XSS Scanner javascript </h1>
   <input name="urlToAnalyze" id="test2" class="inputPanel" type="text" size="20" maxlength="40" value="Inserire URL da analizzare"/>
   <button onclick="TestXSS('payloads')">Ana...lyze</button>
   <p/>

<input type="file" name="file" id="file">
<script type="text/javascript">
document.getElementById('file').onchange = function(){
 var file = this.files[0];

  var reader = new FileReader();
  reader.onload = function(progressEvent){
    // Entire file. Used for debug
    //console.log(this.result);
    var lines = this.result.split('\n');
    let row_number = lines.length;
    if (lines.length > 6){
        alert("Troppi URL!!!");
        return;
    }

      for(var line = 0; line < (lines.length - 1); line++){
        url_to_control = (lines[line]);
        var siteValid = ValidURL(url_to_control);
          if (siteValid == false){
            console.log("Il sito non esiste o non è verificabile!");
          }
      }


};

  reader.readAsText(file);
 }
//Download any elements of array that contain url and take a look of Dom


</script>
</body>
</html>
